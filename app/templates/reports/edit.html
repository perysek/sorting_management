{% extends 'base.html' %}

{% block title %}Edytuj Raport #{{ report.nr_raportu }} - Scrap Data Management{% endblock %}

{% block page_title %}Edycja raportu #{{ report.nr_raportu }}{% endblock %}
{% block page_subtitle %}Modyfikuj dane raportu sortowania{% endblock %}

{% block content %}
<form method="POST" action="{{ url_for('reports.edit', report_id=report.id) }}" class="max-w-4xl space-y-6" id="reportForm">
    <!-- Basic Info Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white">
            <h2 class="text-lg font-semibold text-slate-800">Dane podstawowe</h2>
        </div>
        <div class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="nr_niezgodnosci" class="block text-sm font-medium text-slate-700 mb-1">Numer Niezgodności</label>
                    <input type="text" name="nr_niezgodnosci" id="nr_niezgodnosci" 
                           value="{{ report.nr_niezgodnosci or '' }}"
                           class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow">
                </div>
                <div>
                    <label for="nr_instrukcji" class="block text-sm font-medium text-slate-700 mb-1">Numer Instrukcji</label>
                    <input type="text" name="nr_instrukcji" id="nr_instrukcji" 
                           value="{{ report.nr_instrukcji or '' }}"
                           class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="operator_id" class="block text-sm font-medium text-slate-700 mb-1">Operator <span class="text-red-500">*</span></label>
                    <select name="operator_id" id="operator_id" required
                            class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow bg-white">
                        <option value="">Wybierz operatora...</option>
                        {% for op in operators %}
                        <option value="{{ op.id }}" {{ 'selected' if report.operator_id == op.id else '' }}>
                            {{ op.nr_operatora }} - {{ op.imie_nazwisko }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="data_selekcji" class="block text-sm font-medium text-slate-700 mb-1">Data selekcji <span class="text-red-500">*</span></label>
                    <input type="date" name="data_selekcji" id="data_selekcji" required
                           value="{{ report.data_selekcji.strftime('%Y-%m-%d') if report.data_selekcji else '' }}"
                           class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow">
                </div>
            </div>
            
            <div class="flex items-center gap-3 py-2">
                <input type="checkbox" name="selekcja_na_biezaco" id="selekcja_na_biezaco"
                       {{ 'checked' if report.selekcja_na_biezaco else '' }}
                       class="w-5 h-5 rounded border-slate-300 text-primary-600 focus:ring-primary-500">
                <label for="selekcja_na_biezaco" class="text-sm font-medium text-slate-700">Selekcja na bieżąco</label>
            </div>
        </div>
    </div>
    
    <!-- Quantities Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white">
            <h2 class="text-lg font-semibold text-slate-800">Ilości i defekty</h2>
        </div>
        <div class="p-6 space-y-6">
            <div>
                <label for="ilosc_detali_sprawdzonych" class="block text-sm font-medium text-slate-700 mb-1">
                    Ilość detali sprawdzonych <span class="text-red-500">*</span>
                </label>
                <input type="number" name="ilosc_detali_sprawdzonych" id="ilosc_detali_sprawdzonych" required min="0"
                       value="{{ report.ilosc_detali_sprawdzonych or 0 }}"
                       class="w-full md:w-64 px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow">
            </div>
            
            <!-- Defects Section -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-3">Braki / Defekty (max. 4)</label>
                
                <!-- Add Defect Row -->
                <div class="flex items-end gap-3 mb-4">
                    <div class="flex-1">
                        <label class="block text-xs text-slate-500 mb-1">Nazwa defektu</label>
                        <input type="text" id="defekt_input" 
                               class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow">
                    </div>
                    <div class="w-32">
                        <label class="block text-xs text-slate-500 mb-1">Ilość</label>
                        <input type="number" id="defekt_ilosc_input" min="1"
                               class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow">
                    </div>
                    <button type="button" onclick="addDefekt()"
                            class="px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-medium rounded-xl hover:from-emerald-600 hover:to-emerald-700 shadow-sm transition-all flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Dodaj
                    </button>
                </div>
                
                <!-- Defects List -->
                <div id="defekty_list" class="space-y-2">
                    {% if report.braki_defekty %}
                        {% for defekt in report.braki_defekty %}
                        <div class="flex items-center gap-3 px-4 py-3 bg-slate-50 rounded-xl border border-slate-200 defekt-row">
                            <input type="hidden" name="defekt_nazwa[]" value="{{ defekt.defekt }}">
                            <input type="hidden" name="defekt_ilosc[]" value="{{ defekt.ilosc }}">
                            <div class="flex-1">
                                <span class="font-medium text-slate-800">{{ defekt.defekt }}</span>
                            </div>
                            <div class="w-20 text-right">
                                <span class="px-2 py-1 bg-amber-100 text-amber-700 rounded-lg text-sm font-medium">{{ defekt.ilosc }} szt.</span>
                            </div>
                            <button type="button" onclick="removeDefekt(this)" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="px-4 py-3 bg-slate-50 rounded-xl text-sm text-slate-500 text-center" id="no_defekty_message">
                        Brak dodanych defektów
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Performance Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white">
            <h2 class="text-lg font-semibold text-slate-800">Wydajność i uwagi</h2>
        </div>
        <div class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="zalecana_wydajnosc" class="block text-sm font-medium text-slate-700 mb-1">Zalecana wydajność [szt/godz]</label>
                    <input type="number" name="zalecana_wydajnosc" id="zalecana_wydajnosc" step="0.1" min="0"
                           value="{{ report.zalecana_wydajnosc or '' }}"
                           class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow">
                </div>
                <div>
                    <label for="czas_pracy" class="block text-sm font-medium text-slate-700 mb-1">Czas pracy [godz] <span class="text-red-500">*</span></label>
                    <input type="number" name="czas_pracy" id="czas_pracy" step="0.1" min="0" required
                           value="{{ report.czas_pracy or '' }}"
                           class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow">
                </div>
            </div>
            
            <div>
                <label for="uwagi" class="block text-sm font-medium text-slate-700 mb-1">Uwagi</label>
                <textarea name="uwagi" id="uwagi" rows="2"
                          class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow resize-none">{{ report.uwagi or '' }}</textarea>
            </div>
            
            <div>
                <label for="uwagi_do_wydajnosci" class="block text-sm font-medium text-slate-700 mb-1">Uwagi do wydajności</label>
                <textarea name="uwagi_do_wydajnosci" id="uwagi_do_wydajnosci" rows="2"
                          class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow resize-none">{{ report.uwagi_do_wydajnosci or '' }}</textarea>
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div class="flex items-center gap-4">
        <button type="submit"
                class="px-6 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold rounded-xl hover:from-primary-600 hover:to-primary-700 shadow-md hover:shadow-lg transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Zapisz Zmiany
        </button>
        <a href="{{ url_for('main.index') }}"
           class="px-6 py-3 bg-white border border-slate-300 text-slate-700 font-medium rounded-xl hover:bg-slate-50 transition-colors">
            Anuluj
        </a>
    </div>
</form>

{% endblock %}

{% block scripts %}
<script>
    let defektyCount = document.querySelectorAll('.defekt-row').length;
    const maxDefekty = 4;
    
    function addDefekt() {
        if (defektyCount >= maxDefekty) {
            alert('Można dodać maksymalnie 4 defekty.');
            return;
        }
        
        const nazwa = document.getElementById('defekt_input').value.trim();
        const ilosc = document.getElementById('defekt_ilosc_input').value;
        
        if (!nazwa || !ilosc) {
            alert('Podaj nazwę defektu i ilość.');
            return;
        }
        
        defektyCount++;
        
        // Hide empty message
        const emptyMsg = document.getElementById('no_defekty_message');
        if (emptyMsg) emptyMsg.style.display = 'none';
        
        // Create defect row
        const list = document.getElementById('defekty_list');
        const row = document.createElement('div');
        row.className = 'flex items-center gap-3 px-4 py-3 bg-slate-50 rounded-xl border border-slate-200 defekt-row';
        row.innerHTML = `
            <input type="hidden" name="defekt_nazwa[]" value="${nazwa}">
            <input type="hidden" name="defekt_ilosc[]" value="${ilosc}">
            <div class="flex-1">
                <span class="font-medium text-slate-800">${nazwa}</span>
            </div>
            <div class="w-20 text-right">
                <span class="px-2 py-1 bg-amber-100 text-amber-700 rounded-lg text-sm font-medium">${ilosc} szt.</span>
            </div>
            <button type="button" onclick="removeDefekt(this)" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        `;
        list.appendChild(row);
        
        // Clear inputs
        document.getElementById('defekt_input').value = '';
        document.getElementById('defekt_ilosc_input').value = '';
        document.getElementById('defekt_input').focus();
    }
    
    function removeDefekt(btn) {
        btn.parentElement.remove();
        defektyCount--;
        
        // Show empty message if no defects
        if (defektyCount === 0) {
            const emptyMsg = document.getElementById('no_defekty_message');
            if (emptyMsg) emptyMsg.style.display = 'block';
        }
    }
</script>
{% endblock %}
